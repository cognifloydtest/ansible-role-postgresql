---
- name: yum | Install postgresql
  become: yes
  yum:
    name: "{{ item }}"
    state: installed
  with_items:
    - postgresql-server
    - postgresql-contrib
    - postgresql-devel
  register: install_postgresql
  tags: [db, postgresql]

- name: yum | Initialize Postgresql
  become: yes
  command: postgresql-setup initdb
  when: install_postgresql.changed
  tags: [db, postgresql]

- name: yum | MD5-encrypted password for postgres 1
  become: yes
  replace:
    dest: /var/lib/pgsql/data/pg_hba.conf
    regexp: ^(host.*all.*all.*127.0.0.1\/32.*)ident$
    replace: \1md5
  tags: [db, postgresql]

- name: yum | MD5-encrypted password for postgres 2
  become: yes
  replace:
    dest: /var/lib/pgsql/data/pg_hba.conf
    regexp: ^(host.*all.*all.*::1\/128.*)ident$
    replace: \1md5
  tags: [db, postgresql]

- name: yum | Start and Enable Postgresql
  become: yes
  service:
    name: postgresql
    state: started
    enabled: yes
  tags: [db, postgresql]
